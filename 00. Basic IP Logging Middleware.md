# 📌 Basic IP Logging Middleware

## 📖 Overview
This task implements a **custom Django middleware** that logs the **IP address**, **timestamp**, and **request path** for every incoming request.  
It is the foundation for building a secure and scalable **IP tracking system**.

---

## 🎯 Objectives
- Capture the client’s IP address reliably.  
- Store request metadata (IP, timestamp, path) in the database.  
- Register the middleware in `settings.py` so it runs on each request.  

---

## 🛠 Project Structure
```
ip_tracking/
├── __init__.py
├── middleware.py
└── models.py
```

---

## ⚙️ Implementation

### 1. Middleware
`ip_tracking/middleware.py`
```python
from django.utils import timezone
from ip_tracking.models import RequestLog
from ipware import get_client_ip  # pip install django-ipware

class IPLoggingMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        client_ip, is_routable = get_client_ip(request)
        if client_ip is None:
            client_ip = "0.0.0.0"

        RequestLog.objects.create(
            ip_address=client_ip,
            timestamp=timezone.now(),
            path=request.path
        )

        response = self.get_response(request)
        return response
```

---

### 2. Model
`ip_tracking/models.py`
```python
from django.db import models

class RequestLog(models.Model):
    ip_address = models.GenericIPAddressField()
    timestamp = models.DateTimeField()
    path = models.CharField(max_length=255)

    def __str__(self):
        return f"{self.ip_address} - {self.path} - {self.timestamp}"
```

---

### 3. Register Middleware
In `settings.py`:
```python
MIDDLEWARE = [
    "django.middleware.security.SecurityMiddleware",
    "django.contrib.sessions.middleware.SessionMiddleware",
    "django.middleware.common.CommonMiddleware",
    "django.middleware.csrf.CsrfViewMiddleware",
    "django.contrib.auth.middleware.AuthenticationMiddleware",
    "django.contrib.messages.middleware.MessageMiddleware",
    "django.middleware.clickjacking.XFrameOptionsMiddleware",

    # Custom middleware
    "ip_tracking.middleware.IPLoggingMiddleware",
]
```

---

### 4. Run Migrations
Apply the model to the database:
```bash
python manage.py makemigrations ip_tracking
python manage.py migrate
```

---

## 🧪 Testing
1. Start the development server:
   ```bash
   python manage.py runserver
   ```
2. Visit different URLs (e.g., `/`, `/admin/`, `/about/`).
3. Open the Django shell and query the logs:
   ```bash
   python manage.py shell
   >>> from ip_tracking.models import RequestLog
   >>> RequestLog.objects.all()
   ```

You should see entries with IP, timestamp, and path.

---

## ✅ Expected Output
Each request creates a log entry like:
```
127.0.0.1 - /admin/ - 2025-09-06 14:25:32
```

---

## 📦 Requirements
- Django
- django-ipware (for reliable IP extraction)

Install:
```bash
pip install django django-ipware
```

---

## 📌 Notes
- This is the **foundation task**; later tasks will build on it to implement:
  - **Blacklisting IPs**
  - **Rate limiting**
  - **Geolocation**
  - **Anomaly detection**
- For production, consider:
  - **Batch logging** (e.g., Celery, Redis) to reduce DB load.
  - **Anonymizing IPs** to comply with GDPR/CCPA.
